{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='/style.css') }}">
<script
    src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
    crossorigin="anonymous">
</script>
<style>


.card {

    border: 2.5px solid rgba(0,0,0,.125);
    border-radius: 0.8rem;
}


h1 {
  text-align: center;
  font-weight: 100;
}

#result  {
    margin-top: 1em;
    font-size: 16px;
    color: #36489e;
    //font-weight: 300;
}

.tab {
  font-size: 18px;
  font-weight: 400;
  padding: 0.4em;
  width: 140px;
 
  margin-bottom: 2em;
}



</style>

{%endblock%}

{%block content%}

<div class="starter-template">
  <h1 class="display-6 m-3">FastAPI Celery Redis</h1>
  <hr><br>
  <div>
    <h3>Tasks</h3>
    <p>Pick a task length.</p>
    <div class="btn-group" role="group" aria-label="Basic example">
      <button type="button" class="btn btn-primary" onclick="handleClick(1)">Short</a>
      <button type="button" class="btn btn-primary" onclick="handleClick(2)">Medium</a>
      <button type="button" class="btn btn-primary" onclick="handleClick(3)">Long</a>
    </div>
  </div>
  <br><br>
  <div>
    <h3>Task Status</h3>
    <br>
    <table class="table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Status</th>
          <th>Result</th>
        </tr>
      </thead>
      <tbody id="tasks">
      </tbody>
    </table>
  </div>
</div>


       
    


<script>
  (function() {
  console.log('Sanity Check!');
})();

function handleClick(type) {
  fetch('/tasks', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ type: type }),
  })
  .then(response => response.json())
  .then(data => {
    getStatus(data.task_id)
  })
}

function getStatus(taskID) {
  fetch(`/tasks/${taskID}`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    },
  })
  .then(response => response.json())
  .then(res => {
    console.log(res)
    const html = `
      <tr>
        <td>${taskID}</td>
        <td>${res.task_status}</td>
        <td>${res.task_result}</td>
      </tr>`;
    const newRow = document.getElementById('tasks').insertRow(0);
    newRow.innerHTML = html;

    const taskStatus = res.task_status;
    if (taskStatus === 'SUCCESS' || taskStatus === 'FAILURE') return false;
    setTimeout(function() {
      getStatus(res.task_id);
    }, 1000);
  })
  .catch(err => console.log(err));
}
</script>


{%endblock%}